---
import HtmlLayout from '@/layouts/HtmlLayout.astro';
import Loading from '@/components/loading/Loading.vue';

import { createClient } from '@supabase/supabase-js';
import { characters } from '@/data/characters.js';

export const prerender = false;

const supabase = createClient(
	import.meta.env.PUBLIC_SUPABASE_URL,
	import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// 페이지 데이터 가져오기
const { id } = Astro.params;

let originalUrl = '';
let username = '';
let characterInfo = null;

if (id) {
	try {
		// Supabase에서 URL 조회
		const { data: urlData, error } = await supabase
			.from('shortened_urls')
			.select('original_url')
			.eq('id', id)
			.single();

		if (urlData && !error) {
			originalUrl = urlData.original_url;
			username = id;

			// 원본 URL에서 캐릭터 정보 추출 시도
			try {
				const url = new URL(originalUrl);
				const hash = url.hash.substring(1); // # 제거

				if (hash) {
					// Base64 디코딩 후 UTF-8 디코딩, JSON 파싱
					const decoded = atob(hash);
					const utf8String = decodeURIComponent(escape(decoded));
					characterInfo = JSON.parse(utf8String);
				}
			} catch (error) {
				console.log('캐릭터 정보 파싱 실패:', error);
			}
		}
	} catch (error) {
		console.error('URL 조회 중 오류:', error);
	}
}

// 동적 메타태그 설정
let title = '카트라이더 캐릭터로 알아보는 성격 테스트';
let description =
	'나는 어떤 캐릭터의 성격일까? 카트라이더 캐릭터로 알아보는 성격 테스트를 해보세요!';
let image = '/images/og/og.png';

if (characterInfo && characterInfo.title) {
	const character = characters[characterInfo.title];
	if (character) {
		title = `${username}님은 ${characterInfo.title}와 가장 비슷한 성격을 가지고있어요.`;
		description = `${username}님은 ${characterInfo.title}와 가장 비슷합니다. ${character.metaDescription}`;
		image = character.popupImage;
	}
}
---

<HtmlLayout title={title} description={description} image={image}>
	<!-- 리다이렉트 -->
	<meta http-equiv="refresh" content={`0;url=${originalUrl || '/'}`} />

	<style>
		html,
		body {
			width: 100%;
			height: 100%;
			font-family: 'Pretendard Variable', sans-serif;
		}
	</style>

	<Loading client:load />

	<script>
		// JavaScript로도 리다이렉트 (백업)
		setTimeout(() => {
			window.location.href = '{originalUrl || "/"}';
		}, 100);
	</script>
</HtmlLayout>
