---
// @ts-nocheck

import HtmlLayout from '@/layouts/HtmlLayout.astro';
import MainLayout from '@/layouts/MainLayout.vue';
import ResultContent from '@/components/result/ResultContent.vue';
import ContentsInnerLayout from '@/layouts/ContentsInnerLayout.vue';
import { characters } from '@/data/characters.js';

// 기본 메타데이터 설정 (클라이언트에서 동적으로 변경)
const title = '카트라이더 캐릭터로 알아보는 성격 테스트';
const description =
	'나는 어떤 캐릭터의 성격일까? 카트라이더 캐릭터로 알아보는 성격 테스트를 해보세요!';
const image = '/images/og/og.png';
---

<HtmlLayout bodyClassName="bg-sky-50" title={title} description={description} image={image}>
	<MainLayout client:load>
		<ContentsInnerLayout type="result">
			<ResultContent client:load />
		</ContentsInnerLayout>
	</MainLayout>
	<div class="hidden">
		<img src="/images/profile/img-dao-profile.webp" alt="" />
		<img src="/images/profile/img-bazzi-profile.webp" alt="" />
		<img src="/images/profile/img-diz-profile.webp" alt="" />
		<img src="/images/profile/img-uni-profile.webp" alt="" />
		<img src="/images/profile/img-marid-profile.webp" alt="" />
		<img src="/images/profile/img-tiera-profile.webp" alt="" />
		<img src="/images/profile/img-keffy-profile.webp" alt="" />
		<img src="/images/profile/img-ethen-profile.webp" alt="" />
		<img src="/images/profile/img-kris-profile.webp" alt="" />
		<img src="/images/profile/img-erini-profile.webp" alt="" />
		<img src="/images/profile/img-mos-profile.webp" alt="" />
	</div>

	<script>
		// 결과 페이지에서 단축 URL 생성 및 meta 태그 업데이트
		import { shortenUrl, getUsernameFromUrl } from '@/util/urlShortener.js';

		async function updateMetaUrl() {
			try {
				// 현재 URL에서 username 추출
				const username = getUsernameFromUrl();
				if (!username) {
					console.log('Username을 찾을 수 없어서 meta URL 업데이트를 건너뜁니다.');
					return;
				}

				// 현재 페이지 URL을 단축 URL로 변환
				const currentUrl = window.location.href;
				const shortUrl = await shortenUrl(currentUrl, username);

				if (shortUrl && shortUrl !== currentUrl) {
					// meta 태그 업데이트
					const ogUrlMeta = document.querySelector('meta[property="og:url"]');
					const twitterUrlMeta = document.querySelector('meta[name="twitter:url"]');

					if (ogUrlMeta) {
						ogUrlMeta.setAttribute('content', shortUrl);
					}
					if (twitterUrlMeta) {
						twitterUrlMeta.setAttribute('content', shortUrl);
					}

					console.log('Meta URL 업데이트 완료:', shortUrl);
				} else {
					console.log('단축 URL 생성 실패 또는 현재 URL과 동일:', shortUrl);
				}
			} catch (error) {
				console.error('Meta URL 업데이트 중 오류:', error);
			}
		}

		// 페이지 로드 후 실행 (약간의 지연을 두어 DOM이 완전히 로드된 후 실행)
		setTimeout(updateMetaUrl, 100);
	</script>
</HtmlLayout>
